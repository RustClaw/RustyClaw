name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test and Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

      - name: Run cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run cargo build
        run: cargo build --release

      - name: Run cargo test
        run: cargo test --release

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustyclaw-binary
          path: target/release/rustyclaw

  deploy-proxmox:
    name: Deploy to Proxmox CT210
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      DEPLOY_HOST: 192.168.15.9
      DEPLOY_USER: root
      DEPLOY_PATH: /opt/rustyclaw-alpha
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Create deployment directory on CT210
        run: |
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} "mkdir -p ${DEPLOY_PATH}/config"

      - name: Copy binary to CT210
        run: |
          scp -i ~/.ssh/deploy_key target/release/rustyclaw ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} "chmod +x ${DEPLOY_PATH}/rustyclaw"

      - name: Copy config if not exists
        run: |
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} "
            if [ ! -f ${DEPLOY_PATH}/config/config.yaml ]; then
              echo 'Config file not found, creating from default'
            fi
          "
          scp -i ~/.ssh/deploy_key config/default.yaml ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/config/config.yaml.example || true

      - name: Create systemd service on CT210
        run: |
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} "cat > /etc/systemd/system/rustyclaw-alpha.service <<EOF
          [Unit]
          Description=RustyClaw Alpha Testing Gateway
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=${DEPLOY_PATH}
          ExecStart=${DEPLOY_PATH}/rustyclaw --config ${DEPLOY_PATH}/config/config.yaml serve
          Restart=on-failure
          RestartSec=10
          Environment=\"RUST_LOG=info\"

          [Install]
          WantedBy=multi-user.target
          EOF"

      - name: Reload systemd and restart service on CT210
        run: |
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} "
            systemctl daemon-reload
            systemctl enable rustyclaw-alpha
            systemctl restart rustyclaw-alpha
          "

      - name: Check service status on CT210
        run: |
          sleep 5
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} "systemctl status rustyclaw-alpha --no-pager || true"
          echo "Deployment to CT210 complete!"
          echo "View logs with: ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_HOST} journalctl -u rustyclaw-alpha -f"
